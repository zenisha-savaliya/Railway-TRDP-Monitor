<div class="page-card">
  <div class="page-header">
    <svg viewBox="0 0 24 24" fill="currentColor">
      <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-5 14H4v-4h11v4zm0-5H4V9h11v4zm5 5h-4V9h4v9z"/>
    </svg>
    <h2>Signal Configuration</h2>
  </div>
  
  <div class="top-actions">
    <div class="config-actions">
      <button class="btn btn-download" (click)="downloadConfig()">
        <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
          <path d="M5 20h14v-2H5v2zm7-18L5.33 9h3.67v4h4V9h3.67L12 2z"/>
        </svg>
        Download Config
      </button>

      <button class="btn btn-upload" [disabled]="isUploading" (click)="fileInput.click()">
        <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
          <path d="M5 20h14v-2H5v2zm7-18l-7 7h4v4h6v-4h4l-7-7z"/>
        </svg>
        {{ isUploading ? 'Uploading...' : 'Upload Config' }}
      </button>
      <input
        #fileInput
        type="file"
        accept=".json,.cfg,.txt"
        (change)="onConfigFileSelected($event)"
        style="display: none;"
      />
    </div>
  </div>
  
  <!-- Show configured subsystems so user can see and switch which subsystem they're configuring -->
  <div class="mb-6" *ngIf="configuredSubsystemNames.length > 0">
    <label class="block text-sm font-medium mb-3">Configured Subsystems</label>
    <div class="subsystem-buttons">
      <button
        *ngFor="let sub of configuredSubsystemNames"
        [class.active]="selectedSubsystem === sub"
        (click)="selectedSubsystem = sub; onSubsystemChange(sub)"
        class="btn btn-secondary"
      >
        {{ sub }}
      </button>
    </div>
    <p class="text-muted text-sm mt-2">Signals below are for subsystem: <strong>{{ selectedSubsystem }}</strong>. New signals will be added to this subsystem.</p>
  </div>
  <div class="alert alert-warning mb-6" *ngIf="configuredSubsystemNames.length === 0">
    <p>No subsystems configured. Please configure subsystems first in Subsystem Configuration.</p>
  </div>

  <div class="add-signal-form" *ngIf="configuredSubsystemNames.length > 0">
    <h3>Add New Signal</h3>
    <div class="form-grid">
      <div class="form-group">
        <label>Signal Name</label>
        <input type="text" [(ngModel)]="newSignal.name" class="form-input" placeholder="Signal Name" />
      </div>
      <div class="form-group">
        <label>Subsystem</label>
        <select [(ngModel)]="selectedSubsystem" (ngModelChange)="onSubsystemChange($event)" class="form-input">
          <option *ngFor="let sub of configuredSubsystemNames" [value]="sub">{{ sub }}</option>
        </select>
      </div>
      <div class="form-group">
        <label>Datatype</label>
        <select [(ngModel)]="newSignal.datatype" class="form-input">
          <option *ngFor="let dt of DATATYPE_OPTIONS" [value]="dt">{{ dt }}</option>
        </select>
      </div>
      <div class="form-group">
        <label>COM ID</label>
        <input type="number" [(ngModel)]="newSignal.comid" class="form-input" placeholder="COM ID" />
      </div>
      <div class="form-group">
        <label>Scaling</label>
        <input type="number" step="0.01" [(ngModel)]="newSignal.scaling" class="form-input" />
      </div>
      <div class="form-group">
        <label>Cycle Time (ms)</label>
        <input type="number" [(ngModel)]="newSignal.cycletime" class="form-input" />
      </div>
      <div class="form-group">
        <label>Msg Type</label>
        <select [(ngModel)]="newSignal.msgtype" class="form-input">
          <option *ngFor="let mt of MSGTYPE_OPTIONS" [value]="mt">{{ mt }}</option>
        </select>
      </div>
      <div class="form-group">
        <label>Access</label>
        <select [(ngModel)]="newSignal.access" class="form-input">
          <option *ngFor="let acc of ACCESS_OPTIONS" [value]="acc">{{ acc }}</option>
        </select>
        <small>&nbsp;</small>
      </div>
      <!-- BOOLEAN datatype: keep single on/off toggle -->
      <div class="form-group" *ngIf="newSignal.datatype === 'BOOLEAN'">
        <label>Bit Value</label>
        <div class="toggle-container">
          <button 
            type="button"
            class="toggle-button" 
            [class.active]="bitValue === 1"
            (click)="toggleBitValue()"
          >
            <div class="toggle-slider" [class.active]="bitValue === 1">
              <div class="toggle-knob"></div>
            </div>
            <span class="toggle-label">{{ bitValue === 1 ? 'ON (1)' : 'OFF (0)' }}</span>
          </button>
        </div>
        <small>&nbsp;</small>
      </div>
      <!-- BIT datatype: show 8 checkboxes for 8-bit value -->
      <div class="form-group" *ngIf="newSignal.datatype === 'BIT'">
        <label>Bit Value</label>
        <div class="bit-checkboxes">
          <label 
            class="bit-checkbox" 
            *ngFor="let bit of bitIndexes"
          >
            <input 
              type="checkbox" 
              [checked]="bitBits[bit]" 
              (change)="onBitCheckboxChange(bit, $event)"
            />
            <span>Bit {{ bit }}</span>
          </label>
        </div>
        <small>Decimal value: {{ bitValue }}</small>
      </div>
    </div>

    <div class="add-signal-actions">
      <button class="btn btn-primary" (click)="addSignal()">
        <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
          <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
        </svg>
        Add Signal
      </button>
    </div>
  </div>
  
  <div class="signals-table-container">
    <table class="signals-table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Subsystem</th>
          <th>Datatype</th>
          <th>COM ID</th>
          <th>Scaling</th>
          <th>Cycle (ms)</th>
          <th>Msg Type</th>
          <th>Access</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let signal of getFilteredSignals()">
          <td>{{ signal.name }}</td>
          <td>{{ getSubsystemName(signal.subsystemId) }}</td>
          <td>{{ signal.datatype }}</td>
          <td>{{ signal.comid }}</td>
          <td>{{ signal.scaling }}</td>
          <td>{{ signal.cycletime }}</td>
          <td>{{ signal.msgtype }}</td>
          <td>{{ signal.access }}</td>
          <td>
            <button class="btn btn-danger" (click)="deleteSignal(signal.id)">Delete</button>
          </td>
        </tr>
        <tr *ngIf="getFilteredSignals().length === 0">
          <td colspan="9" style="text-align: center; padding: 2rem; color: #94a3b8;">
            <ng-container *ngIf="configuredSubsystemNames.length === 0">
              No subsystems configured. Please configure subsystems first in Subsystem Configuration.
            </ng-container>
            <ng-container *ngIf="configuredSubsystemNames.length > 0">
              No signals for <strong>{{ selectedSubsystem }}</strong> yet. Add a signal above.
            </ng-container>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div *ngIf="getFilteredSignals().length > 0" class="common-save-bar common-save-bar-bottom">
    <button class="btn btn-success btn-save-all" (click)="saveSignals()" [disabled]="isSaving">
      <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
        <path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/>
      </svg>
      {{ isSaving ? 'Saving...' : 'Save All Signals' }}
    </button>
  </div>
</div>
